# OpenTelemetry 协议需求

本文档将指导 OpenTelemetry 协议设计和 RFC。

## 目标

请参见 OpenTelemetry 协议设计的目标[这里](design-goals.md)。

## 术语

在遥测数据交换中涉及到两个参与方。在本文档中，遥测数据来源方称为客户端，遥测数据目的地方称为服务器。

客户端的示例包括已检测的应用程序或遥测收集器的发送端，服务器的示例包括遥测后端或遥测收集器的接收端（因此收集器通常既是客户端又是服务器，具体取决于您从哪一侧查看）。

## 现有协议的已知问题

我们在 OpenCensus 和其他协议方面的经验表明，许多协议都存在以下一个或多个缺点：

- 收到遥测数据的序列化和尤其是反序列化的 CPU 消耗高。
- 垃圾收集器的高频 CPU 消耗。
- 某些协议（如基于流的 gRPC OpenCensus 协议）缺乏传输保证，这使得遥测管道的故障排除变得困难。
- 不知道/不与负载均衡器合作，导致水平扩展后端可能出现很大的不平衡。
- 支持跟踪或指标，但不能同时支持两者。

我们的目标是在新协议中避免或缓解这些已知问题。

## 要求

以下是 OpenTelemetry 协议的要求。

### 支持的节点类型

协议必须适用于以下所有类型的节点之间的使用：已检测的应用程序、遥测后端、作为本地守护进程运行的遥测代理、独立的收集器/转发器服务。

### 支持的数据类型

协议必须支持跟踪和指标作为数据类型。

### 传输可靠性

协议必须确保可靠的数据传输，并在无法传输数据时具有清晰的可见性。这可以通过从服务器向客户端发送数据确认来实现。

请注意，仅确认本身并不足以保证：a）数据不会丢失，以及 b）数据不会重复。确认可以帮助保证 a），但不能保证 b）。同时保证两者是困难的。因为通常情况下，遥测数据重复要比丢失更好，所以我们选择保证没有数据丢失，同时可能允许重复数据。

重复通常发生在边缘情况（例如，在重新连接、网络中断等情况下），当客户端无法知道最后发送的数据是否已传输。在这些情况下，客户端通常会选择重新发送数据以确保传输，这反过来可能导致服务器端出现重复数据。

_为避免重复，客户端和服务器可以使用唯一标识符来跟踪发送和传输的项目。跟踪 ID 和执行数据去重的确切机制可以在协议层之上定义，并且不在本文档的范围之内。_

因此，我们稍微放宽了要求，在罕见情况下认为重复数据是可以接受的。

注意：本协议关注一对客户端/服务器节点之间的传输可靠性，并旨在确保客户端和服务器之间的数据在传输过程中不会丢失。许多遥测收集系统具有多个节点，数据必须通过这些节点传输，直到到达最终目的地（例如，应用程序 -> 代理 -> 收集器 -> 后端）。这样的系统中的端到端传输保证超出了本文档的范围。本协议中描述的确认发生在单个客户端/服务器对之间，并且不跨越多跳传输路径中的多个节点。

### 吞吐量

协议必须确保在高延迟网络中实现高吞吐量，当客户端和服务器不在同一数据中心时。

这个要求可能会排除半双工协议。半双工协议的吞吐量高度依赖于网络往返时间和请求大小。为了实现良好的吞吐量，请求的大小可能过大，不切实际。

### 压缩

协议必须实现遥测数据的高压缩比。协议设计必须考虑遥测数据的批处理和相似数据的分组（这两者都可以帮助使用常见的压缩算法实现更好的压缩）。

### 加密

必须支持行业标准加密（例如，TLS/HTTPS）。

### 回压信号和节流

协议必须允许回压信号。

如果服务器无法跟上从客户端接收的数据的速度，那么它必须能够将这个事实信号给客户端。然后，客户端可能会自我节流，以避免压倒服务器。

如果底层传输是一个具有自己的流控制机制的流，那么可以通过延迟从服务器的端点读取数据来应用回压，这可以通过底层流控制向客户端发出信号。然而，这种方法使得客户端难以区分服务器过载和网络延迟（由于例如网络丢失）。这种区别对于[可观察性原因](https://github.com/open-telemetry/opentelemetry-service/pull/188)很重要。因此，要求协议允许从服务器明确并清楚地向客户端发出回压信号，而不依赖于使用底层流控制机制的隐式信号。

回压信号应该包括一个提示给客户端，关于数据的理想降低速率。

### 序列化性能

协议必须具有快速的数据序列化和反序列化特性。

理想情况下，它还必须支持非常快速的透传模式（当不需要修改数据时），快速的数据“增强”或“标记”，以及部分检查数据（例如，检查特定标记的存在）。这些要求有助于创建快速的代理和收集器。

### 内存使用情况

协议必须对内存管理器施加最小压力，包括透传场景，当反序列化的数据寿命短暂，必须在短时间后以原样序列化，并且当这种短寿命数据以高频率创建和丢弃（考虑遥测数据转发器）。

遥测协议的实现必须旨在最小化在序列化和反序列化过程中进行的内存分配和释放的数量，并旨在最小化对垃圾收集（对于 GC 语言）的压力。

### 七层负载均衡器友好

协议必须允许七层负载均衡器，如Envoy，对每批遥测数据进行重新分配流量。流量不应该被负载均衡器固定在一个服务器上发送遥测数据的整个持续时间，这可能导致负载均衡器后面的服务器负载不平衡。

### 向后兼容性

协议应该可以随着时间的推移进行演变。实现 OpenTelemetry 协议不同版本的节点应能够进行互操作（可能会降低到功能角度的最低公共分母）。

### 一般要求

协议必须使用众所周知的、成熟的编码和传输机制，这些机制在 OpenTelemetry 支持的广泛语言中有广泛的实现可用性。